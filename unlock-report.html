<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¾“å…¥è®¿é—®å¯†ç  - ç¡çœ åŠ©æ‰‹</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="logo">ç¡çœ åŠ©æ‰‹</div>
            <ul class="nav-links">
                <li><a href="index.html">é¦–é¡µ</a></li>
                <li><a href="content.html">ç¡çœ çŸ¥è¯†</a></li>
                <li><a href="membership.html">ä¼šå‘˜</a></li>
                <li><a href="about.html">å…³äºæˆ‘ä»¬</a></li>
            </ul>
        </div>
    </nav>

    <main>
        <section class="result-section">
            <div class="container">
                <div class="unlock-container" style="max-width: 500px; margin: 80px auto; text-align: center;">
                    <h1 style="margin-bottom: 20px;">ğŸ” è¾“å…¥è®¿é—®å¯†ç </h1>
                    <p style="color: var(--secondary-text); margin-bottom: 30px;">
                        è¯·è¾“å…¥ä»å®¢æœå¾®ä¿¡è·å–çš„è®¿é—®å¯†ç 
                    </p>

                    <div style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <input
                            type="text"
                            id="passwordInput"
                            placeholder="è¯·è¾“å…¥å¯†ç "
                            style="width: 100%; padding: 15px; font-size: 16px; border: 2px solid #E0DED9;
                                   border-radius: 8px; margin-bottom: 20px; box-sizing: border-box; text-align: center;
                                   text-transform: uppercase;"
                            maxlength="20"
                            autocomplete="off"
                        >

                        <button
                            onclick="verifyPassword()"
                            style="width: 100%; padding: 15px; background: var(--primary-color); color: white;
                                   border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-bottom: 15px;">
                            éªŒè¯å¹¶æŸ¥çœ‹æŠ¥å‘Š
                        </button>

                        <p id="errorMessage" style="color: #D32F2F; font-size: 14px; margin: 10px 0; display: none;">
                            å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•
                        </p>

                        <div style="margin-top: 30px; padding-top: 30px; border-top: 1px solid #E0DED9;">
                            <p style="color: var(--secondary-text); font-size: 14px; margin-bottom: 10px;">è¿˜æ²¡æœ‰å¯†ç ï¼Ÿ</p>
                            <a href="result.html" style="color: var(--primary-color); text-decoration: none;">
                                è¿”å›æŸ¥çœ‹è´­ä¹°æ–¹å¼ â†’
                            </a>
                        </div>
                    </div>

                    <div style="background: #FFF9E6; padding: 20px; border-radius: 8px; margin-top: 30px; text-align: left;">
                        <h3 style="margin-top: 0; font-size: 14px; color: var(--text-color);">ğŸ’¡ æ¸©é¦¨æç¤ºï¼š</h3>
                        <ul style="margin: 10px 0; padding-left: 20px; color: var(--secondary-text); font-size: 13px; line-height: 1.6;">
                            <li>å¯†ç ä¸åŒºåˆ†å¤§å°å†™</li>
                            <li>æ¯ä¸ªå¯†ç å¯ä»¥é‡å¤ä½¿ç”¨</li>
                            <li>å¦‚æœå¿˜è®°å¯†ç ï¼Œè¯·è”ç³»å®¢æœå¾®ä¿¡</li>
                            <li>å¯†ç ä¸€èˆ¬åœ¨ä»˜æ¬¾å1-24å°æ—¶å†…å‘é€</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2024 ç¡çœ åŠ©æ‰‹. ç”¨å¿ƒç†è§£ï¼Œç§‘å­¦åŠ©çœ ã€‚</p>
        </div>
    </footer>

    <script>
        // å¯†ç éªŒè¯å‡½æ•°
        async function verifyPassword() {
            const input = document.getElementById('passwordInput');
            const password = input.value.trim().toUpperCase();
            const errorMsg = document.getElementById('errorMessage');

            if (!password) {
                errorMsg.textContent = 'è¯·è¾“å…¥å¯†ç ';
                errorMsg.style.display = 'block';
                return;
            }

            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            const userToken = localStorage.getItem('userToken');
            if (!userToken) {
                errorMsg.textContent = 'è¯·å…ˆç™»å½•è´¦å·';
                errorMsg.style.display = 'block';
                setTimeout(() => {
                    sessionStorage.setItem('loginRedirect', 'unlock-report.html');
                    window.location.href = 'login.html';
                }, 1500);
                return;
            }

            // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤æäº¤
            const button = document.querySelector('button');
            button.disabled = true;
            button.textContent = 'éªŒè¯ä¸­...';

            try {
                // è°ƒç”¨åç«¯APIéªŒè¯å¯†ç 
                const response = await fetch('/api/verify-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password, token: userToken })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // éªŒè¯æˆåŠŸï¼Œæ›´æ–°æœ¬åœ°çŠ¶æ€
                    localStorage.setItem('isPurchased', 'true');

                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    errorMsg.style.display = 'none';
                    alert(data.message || 'è§£é”æˆåŠŸï¼');

                    // è·³è½¬åˆ°æŠ¥å‘Šé¡µé¢
                    window.location.href = 'report.html';
                } else {
                    // éªŒè¯å¤±è´¥
                    errorMsg.textContent = data.error || 'å¯†ç é”™è¯¯ï¼Œè¯·æ£€æŸ¥åé‡è¯•';
                    errorMsg.style.display = 'block';
                    input.value = '';
                    input.focus();
                    button.disabled = false;
                    button.textContent = 'éªŒè¯å¹¶æŸ¥çœ‹æŠ¥å‘Š';
                }
            } catch (error) {
                console.error('Verify password error:', error);
                errorMsg.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
                errorMsg.style.display = 'block';
                button.disabled = false;
                button.textContent = 'éªŒè¯å¹¶æŸ¥çœ‹æŠ¥å‘Š';
            }
        }

        // å›è½¦é”®æäº¤
        document.getElementById('passwordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                verifyPassword();
            }
        });

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•å’Œè´­ä¹°çŠ¶æ€
        window.addEventListener('DOMContentLoaded', function() {
            const userToken = localStorage.getItem('userToken');
            const isPurchased = localStorage.getItem('isPurchased');

            // å¦‚æœæœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
            if (!userToken) {
                alert('è¯·å…ˆç™»å½•è´¦å·');
                sessionStorage.setItem('loginRedirect', 'unlock-report.html');
                window.location.href = 'login.html';
                return;
            }

            // å¦‚æœå·²è´­ä¹°ï¼Œè¯¢é—®æ˜¯å¦ç›´æ¥æŸ¥çœ‹
            if (isPurchased === 'true') {
                if (confirm('æ‚¨å·²ç»è§£é”è¿‡æŠ¥å‘Šï¼Œæ˜¯å¦ç›´æ¥æŸ¥çœ‹ï¼Ÿ')) {
                    window.location.href = 'report.html';
                }
            }
        });
    </script>
</body>
</html>
