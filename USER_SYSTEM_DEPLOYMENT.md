# 用户系统部署指南

## 🎉 恭喜！你的网站已经升级为完整的用户系统

### 新功能特性

1. ✅ **用户注册/登录** - 邮箱账号系统
2. ✅ **一次性密码** - 每个密码只能用一次
3. ✅ **购买记录** - 一次购买，永久查看
4. ✅ **密码管理后台** - 实时查看密码使用状态
5. ✅ **Vercel KV数据库** - 免费云端存储

---

## 📁 新增文件列表

### 前端页面
- `login.html` - 用户注册/登录页面
- `admin-password.html` - 密码管理后台（已升级）

### 后端API
- `api/register.js` - 用户注册
- `api/login.js` - 用户登录
- `api/verify-password.js` - 验证一次性密码
- `api/check-purchase.js` - 检查购买状态
- `api/generate-passwords.js` - 生成一次性密码
- `api/list-passwords.js` - 获取密码列表

### 修改的文件
- `result.html` - 集成登录检查
- `unlock-report.html` - 使用后端API验证
- `report.html` - 检查购买状态

---

## 🚀 部署步骤

### 第1步：提交代码到GitHub

```bash
cd D:\sleep-helper-website

# 初始化git（如果还没有）
git init

# 添加所有文件
git add .

# 提交
git commit -m "Add user system with one-time passwords"

# 推送到GitHub
git remote add origin https://github.com/你的用户名/sleep-helper-website.git
git branch -M main
git push -u origin main
```

### 第2步：在Vercel部署项目

1. 访问 https://vercel.com
2. 点击 "Import Project"
3. 选择你的GitHub仓库
4. 点击 "Deploy"（先不要配置环境变量）

### 第3步：添加Vercel KV数据库

**重要：这是必须的步骤！**

1. 在Vercel项目页面，点击 "Storage"
2. 点击 "Create Database"
3. 选择 "KV" (Key-Value Database)
4. 输入数据库名称：`sleep-helper-db`
5. 选择地区：`Hong Kong` 或 `Singapore`（离中国近，速度快）
6. 点击 "Create"

**完成后，Vercel会自动添加这些环境变量：**
- `KV_REST_API_URL`
- `KV_REST_API_TOKEN`
- `KV_REST_API_READ_ONLY_TOKEN`
- `KV_URL`

### 第4步：配置环境变量

在Vercel项目设置中添加：

```
ADMIN_KEY=你的管理员密钥（自己设置一个复杂的密码）
```

**示例：**
```
ADMIN_KEY=MySuperSecretAdminKey2024
```

### 第5步：重新部署

配置完环境变量后，点击 "Redeploy" 重新部署项目。

---

## 🎯 完整使用流程

### 用户端流程

1. **注册账号**
   - 访问 `login.html`
   - 点击"注册"标签
   - 输入邮箱和密码
   - 注册成功

2. **登录**
   - 输入邮箱和密码
   - 登录成功后跳转到结果页

3. **做评估**
   - 完成12题睡眠评估
   - 查看评估结果

4. **购买报告**
   - 点击"获取完整分析报告 ¥9.9"
   - 看到收款码和微信二维码
   - 扫码支付 ¥9.9
   - 添加你的微信

5. **获取密码**
   - 发送付款截图给你
   - 你给他发送一次性密码

6. **解锁报告**
   - 用户输入密码
   - 密码验证成功（该密码立即失效）
   - 账号标记为"已购买"
   - 查看完整报告

7. **后续访问**
   - 登录后直接查看报告
   - 无需再次输入密码

### 管理员流程

1. **访问管理后台**
   - 打开 `你的域名/admin-password.html`
   - 输入管理员密钥（你在环境变量设置的ADMIN_KEY）

2. **生成密码**
   - 设置前缀（如：SLEEP）
   - 选择数量（如：10个）
   - 点击"生成密码"

3. **查看密码状态**
   - 总密码数
   - 未使用数量
   - 已使用数量
   - 每个密码的详细信息（谁用的、什么时候用的）

4. **发送密码给用户**
   - 用户付款后
   - 点击"复制"按钮
   - 发送给用户

5. **查看使用记录**
   - 刷新列表
   - 已使用的密码会显示：
     - 使用者邮箱
     - 使用时间
     - 标记为"已使用"（无法复制）

---

## 💾 数据库结构

### 用户表 (`user:{email}`)
```json
{
  "email": "user@example.com",
  "passwordHash": "sha256加密后的密码",
  "isPurchased": false,
  "createdAt": "2024-12-29T10:00:00.000Z",
  "lastLoginAt": "2024-12-29T10:05:00.000Z",
  "purchasedAt": null,
  "usedPassword": null
}
```

### 密码表 (`password:{CODE}`)
```json
{
  "code": "SLEEP-A3X9K2",
  "used": false,
  "usedBy": null,
  "usedAt": null,
  "createdAt": "2024-12-29T10:00:00.000Z"
}
```

### Token表 (`token:{TOKEN}`)
```
值：用户邮箱
过期时间：30天
```

---

## 🔒 安全说明

1. **密码加密**
   - 用户密码使用SHA256加密存储
   - 数据库中不保存明文密码

2. **一次性密码**
   - 每个密码只能使用一次
   - 使用后立即标记为已使用
   - 记录使用者和使用时间

3. **登录状态**
   - 使用Token验证
   - Token 30天过期
   - 服务器端验证购买状态

4. **管理员权限**
   - 需要ADMIN_KEY才能访问密码管理
   - 密钥保存在Vercel环境变量中

---

## 📊 成本说明

### 完全免费的部分
- ✅ Vercel托管：免费
- ✅ Vercel KV数据库：免费额度
  - 256MB 存储空间
  - 每天 30,000 次请求
  - 足够几千个用户使用
- ✅ GitHub：免费
- ✅ 域名：Vercel提供免费域名 `你的项目.vercel.app`

### 未来可能的成本
- 如果超过免费额度，Vercel KV收费：
  - $0.25/GB 存储（很便宜）
  - 前30,000次请求免费，之后 $0.20/百万次请求

---

## 🧪 测试清单

部署完成后，请测试以下流程：

### 1. 用户注册/登录
- [ ] 注册新账号
- [ ] 登录已有账号
- [ ] 错误密码提示
- [ ] 重复邮箱提示

### 2. 密码管理
- [ ] 打开管理后台
- [ ] 输入ADMIN_KEY登录
- [ ] 生成10个密码
- [ ] 查看密码列表
- [ ] 复制密码

### 3. 购买流程
- [ ] 未登录时点击购买（应该跳转登录）
- [ ] 登录后点击购买（显示支付二维码）
- [ ] 输入一次性密码
- [ ] 密码验证成功
- [ ] 查看完整报告

### 4. 密码一次性
- [ ] 同一个密码第二次使用（应该失败）
- [ ] 管理后台显示密码已使用
- [ ] 显示使用者和使用时间

### 5. 重复访问
- [ ] 退出登录
- [ ] 重新登录
- [ ] 直接查看报告（无需密码）

---

## ❓ 常见问题

### Q1: 如何查看数据库数据？
A: 在Vercel项目页面 → Storage → 你的KV数据库 → Data Browser

### Q2: 如何修改管理员密钥？
A: Vercel项目 → Settings → Environment Variables → 修改 `ADMIN_KEY`

### Q3: 密码被泄露怎么办？
A:
- 该密码用过一次后自动失效
- 在管理后台可以看到谁用的
- 生成新密码发给其他用户

### Q4: 忘记管理员密钥怎么办？
A: 在Vercel环境变量中查看或重新设置

### Q5: 用户忘记密码怎么办？
A: 目前没有找回密码功能，用户只能：
- 用相同邮箱重新注册（会提示邮箱已存在）
- 联系你手动在数据库修改

### Q6: 如何导出用户数据？
A: Vercel KV → Data Browser → 手动查看
或使用Vercel CLI：
```bash
vercel kv keys 'user:*'
```

### Q7: 免费额度够用吗？
A: 对于大多数个人项目：
- 1000个用户：完全够用
- 10000个用户：可能需要升级
- 每月成本估算：$0-5

---

## 🎯 下一步优化建议

### 短期（1-2周）
1. 添加"找回密码"功能
2. 添加邮箱验证
3. 美化登录页面
4. 添加用户中心

### 中期（1-2个月）
1. 接入自动支付（虎皮椒等）
2. 自动发送密码（无需手动）
3. 用户数据分析
4. 营销活动功能

### 长期（3-6个月）
1. 会员制度
2. 多种套餐
3. 推荐返现
4. 移动APP

---

## 📞 需要帮助？

如果部署过程中遇到问题：

1. **检查环境变量**
   - `ADMIN_KEY` 是否设置
   - KV数据库是否已创建

2. **查看日志**
   - Vercel → 你的项目 → Deployments → 最新部署 → View Function Logs

3. **测试API**
   - 打开浏览器控制台（F12）
   - 查看Network标签
   - 检查API请求和响应

4. **常见错误**
   - `kv is not defined` → KV数据库未配置
   - `401 Unauthorized` → ADMIN_KEY错误
   - `password:xxx not found` → 密码不存在或已删除

---

## ✅ 部署完成检查

- [ ] Vercel部署成功
- [ ] KV数据库已创建
- [ ] ADMIN_KEY已设置
- [ ] 管理后台可以登录
- [ ] 可以生成密码
- [ ] 用户可以注册
- [ ] 用户可以登录
- [ ] 密码验证成功
- [ ] 报告可以查看
- [ ] 收款码显示正常
- [ ] 微信二维码显示正常

全部完成后，你的网站就可以正式运营了！🎉

---

**祝你顺利上线，早日盈利！** 💰
